Parameters:
  S3BucketName:
    Type: String
  LambdaRoleName:
    Type: String
  DBName:
    Type: String

Resources:

  ServerlessChatDB:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref DBName
      AttributeDefinitions:
        - AttributeName: MessageId
          AttributeType: S
        - AttributeName: CreatedAt
          AttributeType: S
      KeySchema:
        - AttributeName: MessageId
          KeyType: HASH
        - AttributeName: CreatedAt
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

  FunctionCreateMessage:
    Type: AWS::Lambda::Function
    Properties:
      Description: "Create a chat message in the DB."
      Code:
        S3Bucket: !Ref S3BucketName
        S3Key: "create-message.zip"
      FunctionName: "CreateMessage"
      Handler: "create-message"
      MemorySize: 128
      Role: !GetAtt [ LambdaFunctionRole, Arn ]
      Runtime: "go1.x"

  LambdaFunctionRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: "sts:AssumeRole"
            Principal:
              Service: lambda.amazonaws.com
            Effect: Allow
      Policies:
        - PolicyName: Policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Resource: "arn:aws:logs:*:*:*"
                Action:
                  - "logs:*"
              - Effect: Allow
                Resource: "*"
                Action:
                  - "lambda:InvokeFunction"
              - Effect: Allow
                Resource: "*"
                Action:
                  - "dynamodb:*"
              - Effect: Allow
                Resource: "*"
                Action:
                  - "s3:*"
