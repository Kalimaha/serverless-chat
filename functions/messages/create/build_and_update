#!/usr/bin/env bash
set -e
source ../../../config/settings

# validate user input
if [[ $# -ne 1 ]]; then
  echo
  echo "Wrong number of parameters. Usage: ./build_and_update [test|prod]"
  echo
  exit 1
fi

# install dependencies
go get -d ./...

# compile Go
GOARCH=amd64 GOOS=linux go build -o $FUNCTION_CREATE_MESSAGE_NAME

# change permissions
chmod u+x $FUNCTION_CREATE_MESSAGE_NAME

# zip executable
zip $FUNCTION_CREATE_MESSAGE_NAME.zip $FUNCTION_CREATE_MESSAGE_NAME

# upload zip to S3 - it's not required but at least everything is consistent
aws --profile $AWS_PROFILE s3 cp $FUNCTION_CREATE_MESSAGE_NAME.zip s3://$BUCKET_NAME_PREFIX-$1/

# update lambda function
aws --profile $AWS_PROFILE lambda update-function-code --function-name $FUNCTION_CREATE_MESSAGE_NAME --s3-bucket $BUCKET_NAME_PREFIX-$1 --s3-key $FUNCTION_CREATE_MESSAGE_NAME.zip --publish

# cleanup
rm $FUNCTION_CREATE_MESSAGE_NAME $FUNCTION_CREATE_MESSAGE_NAME.zip

# test call
aws --profile sideprojects lambda invoke --function-name $FUNCTION_CREATE_MESSAGE_NAME response.json

# print response
echo
cat response.json
echo
